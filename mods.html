<!DOCTYPE html>
<html lang="en">
<link rel="icon" type="image/png" href="assets/icons/favicon.png">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Owen Lab • Mods</title>
    <link rel="stylesheet" href="style.css" />
</head>
<body>
<header class="top-nav">
    <div class="nav-left">
        <a href="index.html" class="brand">Owen Lab</a>
    </div>
    <nav class="nav-links">
        <a href="index.html" class="nav-btn">Overview</a>
        <a href="projects.html" class="nav-btn">Projects</a>
        <a href="mods.html" class="nav-btn active">Mods</a>
        <a href="addons.html" class="nav-btn">Addons</a>
    </nav>
</header>

<main>
    <!-- Page intro -->
    <section class="section">
        <h1>Minecraft Mods</h1>
        <p>
            This page is for my <strong>Minecraft: Java Edition</strong> mods,
            built using the <strong>Fabric</strong> mod loader for versions
            <strong>1.20.4 and above</strong>. As I update old projects and
            create new ones, they’ll be listed here with screenshots and links.
        </p>
    </section>

    <!-- Mod block: HalaMusic -->
    <section class="section project-block">
        <div class="project-header">
            <h2>HalaMusic (Fabric Mod)</h2>
            <p>
                A Fabric mod for <strong>Minecraft: Java Edition</strong> that adds ruby ore and blocks,
                ruby tools and armor, a custom Gem Polishing Station, and several custom music discs
                inspired by the artist <strong>HalaCG</strong>.
            </p>

            <p style="margin-top: 0.75rem;">
                <strong>Modrinth:</strong>
                <a href="https://modrinth.com/mod/halacg-music" target="_blank" rel="noopener">
                    modrinth.com/mod/halacg-music
                </a>
                <br />
                <strong>Source:</strong>
                <a href="https://github.com/omueller5/halamusic" target="_blank" rel="noopener">
                    github.com/omueller5/halamusic
                </a>
            </p>

            <p style="margin-top: 0.75rem; opacity: 0.9;">
                <strong>Music credit:</strong> All music is owned and copyrighted by <strong>HalaCG</strong>.
                Please support the original artist:
                <a href="https://www.youtube.com/channel/UCFbfFv3bjWctmO2IQoHLiHg" target="_blank" rel="noopener">YouTube</a>
                •
                <a href="https://open.spotify.com/artist/0Tbadays3Z2K3BxmvjL34J" target="_blank" rel="noopener">Spotify</a>
            </p>

            <!-- Auto pills for HalaMusic -->
            <span class="pill" id="hm-mod-version">Mod Version: …</span>
            <span class="pill" id="hm-total-downloads">Downloads: …</span>

            <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <span class="pill">Fabric</span>
                <span class="pill">1.20.4+</span>
                <span class="pill">Ruby Ore</span>
                <span class="pill">Tools & Armor</span>
                <span class="pill">Music Discs</span>
            </div>
        </div>

        <!-- Screenshot gallery for HalaMusic -->
        <div class="project-gallery">
            <figure class="shot">
                <img src="assets/images/mods/MC2.png"
                     alt="Player wearing ruby armor added by HalaMusic" />
                <figcaption>Ruby armor set</figcaption>
            </figure>

            <figure class="shot">
                <img src="assets/images/mods/MC1.png"
                     alt="Items and blocks added by the HalaMusic mod" />
                <figcaption>Items & blocks</figcaption>
            </figure>

            <figure class="shot">
                <img src="assets/images/mods/MC3.png"
                     alt="Gem Polishing Station crafting block from HalaMusic" />
                <figcaption>Gem Polishing Station</figcaption>
            </figure>
        </div>
    </section>

    <!-- Mod block: Bladebound -->
    <section class="section project-block">
        <div class="project-header">
            <h2>Bladebound (Fabric Mod)</h2>
            <p>
                A progression-focused mod featuring legendary swords hidden within rare
                shrine structures across the world. Explore, discover shrines, and commit
                to mastering your blade.
            </p>

            <p style="margin-top: 0.75rem;">
                <strong>Modrinth:</strong>
                <a href="https://modrinth.com/project/bladebound" target="_blank" rel="noopener">
                    modrinth.com/project/bladebound
                </a>
                <br />
                <strong>Details:</strong>
                <a href="./mods/bladebound.html" rel="noopener">
                    Open the Bladebound page
                </a>
            </p>

            <span class="pill" id="bb-mod-version">Mod Version: …</span>
            <span class="pill" id="bb-total-downloads">Total Downloads: …</span>

            <div style="margin-top: 0.75rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                <span class="pill">Fabric</span>
                <span class="pill">1.21.1</span>
                <span class="pill">Worldgen</span>
                <span class="pill">Progression</span>
                <span class="pill">Legendary Swords</span>
            </div>
        </div>

        <!-- Bladebound gallery -->
        <div class="project-gallery">
            <figure class="shot">
                <img src="assets/images/mods/shrine-1.png"
                     alt="Bladebound shrine screenshot 1" />
                <figcaption>Blade Shrine</figcaption>
            </figure>

            <figure class="shot">
                <img src="assets/images/mods/shrine-2.png"
                     alt="Bladebound shrine screenshot 2" />
                <figcaption>Blade Shrine</figcaption>
            </figure>

            <figure class="shot">
                <img src="assets/images/mods/shrine-3.png"
                     alt="Bladebound shrine screenshot 3" />
                <figcaption>Blade Shrine</figcaption>
            </figure>
        </div>
    </section>

    <!-- Placeholder for future mods -->
    <section class="section project-block muted">
        <div class="project-header">
            <h2>More Mods Coming Soon</h2>
            <p>
                As I create or update more Fabric mods for newer Minecraft
                versions, they’ll appear here with their own sections,
                setup notes, and screenshots.
            </p>
        </div>
    </section>
</main>

<footer class="footer">
    <p>© <span id="year"></span> Owen Lab. All rights reserved.</p>
</footer>

<script src="script.js"></script>

<script>
    // =========================================================
    // Footer year
    // =========================================================
    const yearEl = document.getElementById("year");
    if (yearEl) yearEl.textContent = new Date().getFullYear();

    // =========================================================
    // Helpers
    // =========================================================
    function formatCount(n) {
        if (!Number.isFinite(n)) return "…";
        return Intl.NumberFormat("en-US", { notation: "compact", maximumFractionDigits: 1 }).format(n);
    }

    // =========================================================
    // Modrinth: latest version + downloads
    // =========================================================
    async function getModrinthDownloads(projectSlugOrId) {
        const res = await fetch(`https://api.modrinth.com/v2/project/${projectSlugOrId}`, {
            headers: { "Accept": "application/json" }
        });
        if (!res.ok) throw new Error("Modrinth project API error");
        const data = await res.json();
        return Number(data?.downloads) || 0;
    }

    async function getModrinthLatestVersion(projectSlugOrId) {
        const url = new URL(`https://api.modrinth.com/v2/project/${projectSlugOrId}/version`);
        const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("Modrinth version API error");

        const versions = await res.json();
        if (!Array.isArray(versions) || versions.length === 0) return null;

        const releases = versions.filter(v => v && v.version_type === "release");
        const list = releases.length ? releases : versions;

        list.sort((a, b) => new Date(b.date_published) - new Date(a.date_published));
        const latest = list[0];
        return latest?.version_number || latest?.name || null;
    }

    async function setModrinthPills({ project, versionPillId, downloadsPillId, downloadsLabel }) {
        const vEl = document.getElementById(versionPillId);
        const dEl = document.getElementById(downloadsPillId);

        try {
            const [ver, dl] = await Promise.all([
                getModrinthLatestVersion(project),
                getModrinthDownloads(project)
            ]);

            if (vEl && ver) vEl.textContent = `Mod Version: ${ver}`;
            if (dEl) dEl.textContent = `${downloadsLabel}: ${formatCount(dl)}`;
        } catch (e) {
            // Leave fallbacks if anything fails
        }
    }

    // =========================================================
    // CurseForge via CFWidget: Bladebound downloads (to sum with Modrinth)
    // =========================================================
    async function fetchCFWidget(path, retries = 7, delayMs = 650) {
        const url = `https://api.cfwidget.com/${path}`;

        for (let i = 0; i <= retries; i++) {
            const res = await fetch(url, { headers: { "Accept": "application/json" } });

            // 202 = queued/not ready yet (retry)
            if (res.status === 202) {
                if (i === retries) throw new Error("CFWidget queued too long");
                await new Promise(r => setTimeout(r, delayMs));
                continue;
            }

            if (!res.ok) throw new Error(`CFWidget error ${res.status}`);
            return await res.json();
        }

        throw new Error("CFWidget fetch failed");
    }

    function extractTotalDownloads(data) {
        const d = data && data.downloads ? data.downloads : null;
        if (!d) return NaN;

        const candidates = [
            d.total,
            d.totalDownloads,
            d.downloads,
            d.all_time,
            d.allTime
        ];

        for (const v of candidates) {
            const num = Number(v);
            if (Number.isFinite(num)) return num;
        }

        return NaN;
    }

    async function setBladeboundTotalDownloads() {
        const pill = document.getElementById("bb-total-downloads");
        if (!pill) return;

        const mrProject = "bladebound";
        const cfPath = "minecraft/mc-mods/bladebound"; // from https://www.curseforge.com/minecraft/mc-mods/bladebound

        try {
            const [mr, cfData] = await Promise.all([
                getModrinthDownloads(mrProject),
                fetchCFWidget(cfPath)
            ]);

            const cf = extractTotalDownloads(cfData);
            const total = mr + (Number.isFinite(cf) ? cf : 0);

            pill.textContent = `Total Downloads: ${formatCount(total)}`;
        } catch (e) {
            // Leave fallback if anything fails
        }
    }

    // =========================================================
    // Run
    // =========================================================

    // HalaMusic (Modrinth-only)
    setModrinthPills({
        project: "halacg-music",
        versionPillId: "hm-mod-version",
        downloadsPillId: "hm-total-downloads",
        downloadsLabel: "Downloads"
    });

    // Bladebound: version from Modrinth
    setModrinthPills({
        project: "bladebound",
        versionPillId: "bb-mod-version",
        downloadsPillId: "bb-total-downloads", // will be overwritten by total (MR+CF) below
        downloadsLabel: "Downloads"
    });

    // Bladebound: total downloads (Modrinth + CurseForge)
    setBladeboundTotalDownloads();
</script>
</body>
</html>
